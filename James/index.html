<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>James AI - Image & Text Assistant</title>
    <style>
        /* Previous CSS styles remain the same, just adding new ones */
        
        .typing-text {
            display: inline;
        }
        
        .cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background: #007bff;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }
        
        .message-content {
            min-height: 20px;
        }
        
        .image-quality-notice {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Previous HTML structure remains the same -->
    
    <script>
        let currentMode = 'chat';
        let uploadedImages = [];
        let isStreaming = false;
        let currentStreamMessage = null;

        // Previous functions remain the same until addMessage...

        function addMessage(message, isUser = false, images = [], modelUsed = null, isStreaming = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            let bubbleContent = '';
            
            // Show uploaded images in user message
            if (isUser && images.length > 0) {
                images.forEach(imgData => {
                    bubbleContent += `<img src="${imgData}" class="chat-image" alt="Uploaded image"><br>`;
                });
            }
            
            // Handle generated images from AI
            if (message.startsWith('IMAGE_GENERATED:')) {
                const imageData = message.replace('IMAGE_GENERATED:', '');
                const timestamp = new Date().getTime();
                const filename = `high-quality-image-${timestamp}.jpg`;
                
                bubbleContent += `
                    <div style="text-align: center;">
                        <img src="${imageData}" class="chat-image" alt="Generated image">
                        <br>
                        <button class="download-btn" onclick="downloadImage('${imageData}', '${filename}')">
                            üì• Download High Quality Image
                        </button>
                        <div class="image-quality-notice">
                            üé® High quality image generated with enhanced settings
                        </div>
                    </div>
                    <br>`;
                message = 'üé® Here is your high quality generated image!';
            }
            
            if (isStreaming) {
                // For streaming messages
                bubbleContent += `
                    <div class="message-content">
                        <span class="typing-text" id="streamingText"></span>
                        <span class="cursor"></span>
                    </div>`;
            } else {
                // For normal messages
                bubbleContent += `<div class="message-content">${message}</div>`;
            }
            
            // Add model info for AI messages
            if (!isUser && modelUsed && !isStreaming) {
                bubbleContent += `<div class="message-info">Generated with: ${modelUsed}</div>`;
            }
            
            messageDiv.innerHTML = `<div class="message-bubble">${bubbleContent}</div>`;
            
            if (isStreaming) {
                messageDiv.id = 'streamingMessage';
                currentStreamMessage = messageDiv;
            }
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
            
            return messageDiv;
        }

        // Real-time typing effect
        function typeText(text, element, speed = 20) {
            return new Promise((resolve) => {
                let i = 0;
                const timer = setInterval(() => {
                    if (i < text.length) {
                        element.innerHTML = text.substring(0, i + 1);
                        i++;
                        scrollToBottom();
                    } else {
                        clearInterval(timer);
                        resolve();
                    }
                }, speed);
            });
        }

        // Modified sendMessage for streaming effect
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const sendButton = document.getElementById('sendButton');
            
            if (!message && uploadedImages.length === 0) {
                alert("Please enter a message or upload an image");
                return;
            }

            if (isStreaming) return; // Prevent multiple requests

            sendButton.disabled = true;
            sendButton.innerHTML = '<span>Sending...</span><span>‚è≥</span>';
            
            addMessage(message, true, [...uploadedImages]);

            messageInput.value = '';
            const userImages = [...uploadedImages];
            
            clearImagePreviews();
            
            // Show typing indicator
            showTypingIndicator();

            try {
                const requestBody = {
                    message: message,
                    mode: currentMode
                };

                if (currentMode === 'analyze' && userImages.length > 0) {
                    requestBody.images = userImages;
                }

                console.log("üì§ Sending request:", { 
                    mode: currentMode, 
                    message: message,
                    hasImages: userImages.length > 0 
                });

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'X-Request-ID': `msg-${Date.now()}`
                    },
                    body: JSON.stringify(requestBody),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log("üì• API Response:", data);

                // Hide typing indicator
                hideTypingIndicator();

                if (data.success) {
                    if (data.text.startsWith('IMAGE_GENERATED:')) {
                        // For images, show directly
                        addMessage(data.text, false, [], data.modelUsed);
                    } else {
                        // For text, show streaming effect
                        isStreaming = true;
                        const messageDiv = addMessage('', false, [], data.modelUsed, true);
                        const streamingText = messageDiv.querySelector('#streamingText');
                        
                        await typeText(data.text, streamingText, 10);
                        
                        // Remove cursor after typing completes
                        const cursor = messageDiv.querySelector('.cursor');
                        if (cursor) cursor.remove();
                        
                        // Add model info after streaming completes
                        const messageInfo = document.createElement('div');
                        messageInfo.className = 'message-info';
                        messageInfo.textContent = `Generated with: ${data.modelUsed}`;
                        messageDiv.querySelector('.message-bubble').appendChild(messageInfo);
                        
                        isStreaming = false;
                        currentStreamMessage = null;
                    }
                } else {
                    addMessage(`‚ùå ${data.text || 'An error occurred'}`, false);
                }
            } catch (error) {
                console.error('‚ùå Network error:', error);
                hideTypingIndicator();
                addMessage('‚ùå Network error. Please check your connection and try again.', false);
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = '<span>Send</span><span>üì§</span>';
                messageInput.focus();
                messageInput.style.height = 'auto';
                isStreaming = false;
            }
        }

        // Download function
        function downloadImage(imageData, filename) {
            const link = document.createElement('a');
            link.href = imageData;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Rest of your existing functions...
    </script>
</body>
</html>
